<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<recordset table="wizard">
  <record id="name=&quot;RuleSet.chatAssignment_2&quot;" recordid="RuleSet.chatAssignment_2">
    <name type="string">RuleSet.chatAssignment_2</name>
    <file.selection type="string">passed</file.selection>
    <create.record.filename NullValue="1" type="string"/>
    <select.record.filename NullValue="1" type="string"/>
    <select.query NullValue="1" type="string"/>
    <resolve.variables NullValue="1" type="boolean"/>
    <wizard.type type="string">input</wizard.type>
    <wizard.variables sctype="array">
      <wizard.variables sctype="string">$L.tablename</wizard.variables>
    </wizard.variables>
    <initial.process NullValue="1" type="string"/>
    <init.expressions sctype="array">
      <init.expressions sctype="operator">$groupfield=$L.groupfield</init.expressions>
      <init.expressions sctype="operator">$contactfield=$L.contactfield</init.expressions>
      <init.expressions sctype="operator">$servicefield=$L.servicefield</init.expressions>
      <init.expressions sctype="operator">$script=$L.ruleScript</init.expressions>
      <init.expressions sctype="operator">$deptbased=$L.deptbased</init.expressions>
      <init.expressions sctype="operator">$servicebased=$L.servicebased</init.expressions>
      <init.expressions sctype="operator">$locationbased=$L.locationbased</init.expressions>
      <init.expressions sctype="operator">$languagebased=$L.languagebased</init.expressions>
      <init.expressions sctype="operator">$companybased=$L.companybased</init.expressions>
      <init.expressions sctype="operator">ruleDesc in $L.file=nullsub(ruleDesc in $L.file, "Chat Assignment Rule")</init.expressions>
      <init.expressions sctype="operator">if (not  (null(conditionXML in $L.file))) then ($xmlString=nullsub($xmlString, conditionXML in $L.file)) else cleanup($xmlString)</init.expressions>
    </init.expressions>
    <run.expressions NullValue="1" type="boolean"/>
    <expressions sctype="array">
      <expressions sctype="operator">$L.ruleScript=$script</expressions>
      <expressions sctype="operator">$L.deptbased=$deptbased</expressions>
      <expressions sctype="operator">$L.servicebased=$servicebased</expressions>
      <expressions sctype="operator">$L.locationbased=$locationbased</expressions>
      <expressions sctype="operator">$L.languagebased=$languagebased</expressions>
      <expressions sctype="operator">$L.companybased=$companybased</expressions>
      <expressions sctype="operator">$L.groupfield=$groupfield</expressions>
      <expressions sctype="operator">$L.contactfield=$contactfield</expressions>
      <expressions sctype="operator">$L.servicefield=$servicefield</expressions>
    </expressions>
    <run.process NullValue="1" type="boolean"/>
    <process.name NullValue="1" type="string"/>
    <run.format.control NullValue="1" type="boolean"/>
    <format.control type="string">RuleSet.chatAssignment</format.control>
    <format.control.type type="string">add</format.control.type>
    <bad.validation.action type="string">return</bad.validation.action>
    <display.when.complete NullValue="1" type="boolean"/>
    <display.mode NullValue="1" type="string"/>
    <allow.finish NullValue="1" type="boolean"/>
    <restart.condition NullValue="1" type="boolean"/>
    <next.wizard sctype="array">
      <next.wizard sctype="string">RuleSet.chatAssignment_3</next.wizard>
    </next.wizard>
    <next.wizard.cond sctype="array">
      <next.wizard.cond sctype="boolean">true</next.wizard.cond>
    </next.wizard.cond>
    <link.record NullValue="1" type="string"/>
    <prompt type="string">scmsg(201,"ruleset")</prompt>
    <message NullValue="1" sctype="array">
      <message NullValue="1" type="string"/>
    </message>
    <message.cond NullValue="1" sctype="array">
      <message.cond NullValue="1" type="boolean"/>
    </message.cond>
    <message.type NullValue="1" sctype="array">
      <message.type NullValue="1" type="string"/>
    </message.type>
    <sub.format type="string">RuleSet.chatAssignment</sub.format>
    <use.file.as.selection NullValue="1" type="boolean"/>
    <query.for.records NullValue="1" type="boolean"/>
    <query.for.records.filename NullValue="1" type="string"/>
    <query.for.records.query NullValue="1" type="string"/>
    <title type="string">scmsg(200,"ruleset")</title>
    <select.no.records NullValue="1" type="string"/>
    <bitmap NullValue="1" type="string"/>
    <perform.action.on type="string">file</perform.action.on>
    <reset.to.selections NullValue="1" type="boolean"/>
    <window.title type="string">scmsg(200,"ruleset")</window.title>
    <display.screen type="string">RuleSetWizard.condition</display.screen>
    <mult.field.name NullValue="1" type="string"/>
    <message.level NullValue="1" sctype="array">
      <message.level NullValue="1" type="decimal"/>
    </message.level>
    <start NullValue="1" type="boolean"/>
    <usage NullValue="1" sctype="array">
      <usage NullValue="1" type="string"/>
    </usage>
    <query.for.records.sort NullValue="1" sctype="array">
      <query.for.records.sort NullValue="1" type="string"/>
    </query.for.records.sort>
    <allow.skip NullValue="1" type="boolean"/>
    <query.select.one.record NullValue="1" type="string"/>
    <comments NullValue="1" sctype="array">
      <comments NullValue="1" type="string"/>
    </comments>
    <query.select.no.records NullValue="1" type="string"/>
    <query.no.records.msg NullValue="1" type="string"/>
    <brief.description type="string">Chat Assignment Routing</brief.description>
    <cancel.expressions sctype="array">
      <cancel.expressions sctype="operator">cleanup($fieldName);cleanup($script)</cancel.expressions>
    </cancel.expressions>
    <global.lists NullValue="1" sctype="array">
      <global.lists NullValue="1" type="string"/>
    </global.lists>
    <javascript.actions NullValue="1" type="string"/>
    <javascript.init type="string">var $ = lib.c.$;
var _ = lib.Underscore.require();
var fields=getFileFields(vars['$L.tablename'],$.Character,$.Array);
var fieldValues = $.createSCArray();
var fieldDisps = $.createSCArray();
_.each(fields, function(field) {
        fieldValues.push(field.value);
        fieldDisps.push(field.disp);
});
vars['$chat.field.values']=fieldValues;
vars['$chat.field.values.dis']=fieldDisps;

function getFileFields(filename, type,type1) {
  var fields = [];

  var datadict = $("datadict").select('name="' + filename + '"').uniqueResult();
  var setting = $("settings").select('name="Condition Editor"').uniqueResult();
  var settingIds = setting["settingId"];
  var settingValues = setting["settingValue"];
  var displaySystemfields = false;
  var displayDeprecatedfields = false;
  for (var i = 0, iLoopTimes = settingIds.length(); i &lt; iLoopTimes; i++) {
    var settingId = settingIds[i];
    if ("display.systemfields" == settingId) {
      displaySystemfields = (settingValues[i] == "true");
    }
    if ("display.deprecatedfields" == settingId) {
      displayDeprecatedfields = (settingValues[i] == "true");
    }
  }
  if (datadict != null) {
    var dbdict = $(filename).dbdict();
    var descriptor = $("#dbdictService").getDescriptorMeta(dbdict["field"]);
    var allFields = dbdict["field"];
    var datadictFields = datadict["fields"];
    var datadictCaptions = datadict["captions"];
    var sysFieldTypes = datadict["sysFieldType"];
    checkFields(descriptor.childs, datadictFields, datadictCaptions, sysFieldTypes, fields, displaySystemfields, displayDeprecatedfields, type,type1);
  }

  if (fields.length &gt; 0) {
    fields = _.sortBy(fields, "disp");
  }

  return fields;
}

function checkFields(childs, datadictFields, datadictCaptions, sysFieldTypes, fields, displaySystemfields, displayDeprecatedfields, type,type1) {
  var _index=system.functions.index;
  var scmsg = system.functions.scmsg;
  var sccaption="";
  for (var i = 0; i &lt; childs.length; i++) {
    var child = childs[i];
    if (child.field.type === type || child.field.type === type1) {
	    var fieldName = child.field.name;
	    var idx = _index(fieldName, datadictFields);
	    if (idx &lt;= 0) { // try filed name with parent
	    	idx = _index(child.parent.field.name + "," + fieldName, datadictFields);
	    }
	    if (idx &gt; 0) {
		  var datadictType = sysFieldTypes[idx-1];
		  // skip system fields
		  if (datadictType === 1 &amp;&amp; !displaySystemfields) {
		    continue;
		  }

		  // skip deprecated fields
		  if (datadictType === 4 &amp;&amp; !displayDeprecatedfields) {
		    continue;
		  }

		  caption = datadictCaptions[idx-1];
		  var captionStr = scmsg(caption, "sccaption");
		  if (null!==captionStr &amp;&amp; captionStr.indexOf("Could not be found") == -1) {
		    caption = captionStr;
		  }
		  fields.push({
		    value: fieldName,
		    disp: caption
		  });
		}
	} else if (child.childs.length &gt; 0 ) {
      checkFields(child.childs, datadictFields, datadictCaptions, sysFieldTypes, fields, displaySystemfields, displayDeprecatedfields, type,type1);
    }
  }
}</javascript.init>
    <javascript.cancel NullValue="1" type="string"/>
    <disable.next.previous NullValue="1" type="boolean"/>
    <sysmodtime type="dateTime">11/17/15 09:10:04</sysmodtime>
    <sysmoduser type="string">hanrui</sysmoduser>
    <sysmodcount type="decimal">64</sysmodcount>
    <disable.next NullValue="1" type="boolean"/>
    <reset.current.file NullValue="1" type="boolean"/>
    <disable.previous NullValue="1" type="boolean"/>
    <formName type="string">wizard.okonly</formName>
    <noPromptOnCancel NullValue="1" type="boolean"/>
    <prev.wizard NullValue="1" sctype="array">
      <prev.wizard NullValue="1" type="string"/>
    </prev.wizard>
    <prev.wizard.cond NullValue="1" sctype="array">
      <prev.wizard.cond NullValue="1" type="boolean"/>
    </prev.wizard.cond>
    <previous.cond NullValue="1" type="boolean"/>
  </record>
</recordset>

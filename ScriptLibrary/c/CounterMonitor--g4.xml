<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<recordset table="ScriptLibrary">
  <record id="name=&quot;CounterMonitor&quot;" recordid="CounterMonitor">
    <name type="string">CounterMonitor</name>
    <script type="string">var WARNING_VALUE = 1800000000;

function getConsumedWarningCounters() {
    var counterList = [];
    var counter = new SCFile("counters");
    var rc = counter.doSelect("true");
    while (rc == RC_SUCCESS) {
        if (counter["current.value"] &gt; WARNING_VALUE) {
            var counterValue = {};
            counterValue["type"] = "counters";
            counterValue["name"] = counter["table.name"];
            counterValue["value"] = counter["current.value"];
            counterList.push(counterValue);
        }
        rc = counter.getNext();
    }
    
    return counterList;
}

function getConsumedWarningNumbers() {
    var numberList = [];
    var number = new SCFile("number");
    var rc = number.doSelect("true");
    while (rc == RC_SUCCESS) {
        if (number["number"] &gt; WARNING_VALUE) {
            var numberValue = {};
            numberValue["type"] = "number";
            numberValue["name"] = number["name"];
            numberValue["value"] = number["number"];
            numberList.push(numberValue);
        }
        rc = number.getNext();
    }
    
    return numberList;
}

function generateCounterWarningMailBody(counterValues, body) {
    if (counterValues == null || counterValues.length ==0) {
        return null;
    }
    
    var table = "&lt;table style=\"FONT-SIZE: 11pt; FONT-FAMILY: Metric Regular, arial\" cellspacing=\"2\" cellpadding=\"6\" width=\"94%\" align=\"right\" border=\"1\"&gt;";
    table += "  &lt;tbody&gt;\n";
    table += "    &lt;tr&gt;\n";
    table += "      &lt;th align=\"left\"&gt;" + funcs.scmsg("counter:type", "monitor") + "&lt;/th&gt;\n";
    table += "      &lt;th align=\"left\"&gt;" + funcs.scmsg("counter:tablename", "monitor") + "&lt;/th&gt;\n";
    table += "      &lt;th align=\"right\"&gt;" + funcs.scmsg("counter:value", "monitor") + "&lt;/th&gt;\n";
    table += "    &lt;/tr&gt;\n";
    for (var i=0; i&lt;counterValues.length; i++) {
        table += "    &lt;tr&gt;\n";
        table += "      &lt;td align=\"left\"&gt;" + funcs.scmsg(counterValues[i]["type"], "tablename") + "&lt;/td&gt;\n";
        table += "      &lt;td align=\"left\"&gt;" + counterValues[i]["name"] + "&lt;/td&gt;\n";
        table += "      &lt;td align=\"right\"&gt;" + counterValues[i]["value"] + "&lt;/td&gt;\n";
        table += "    &lt;/tr&gt;\n";
    }
    table += "  &lt;/tbody&gt;\n";
    table += "&lt;/table&gt;\n";
    
    if (body == null || body == "") {
        body = "&lt;html&gt;\n" + table + "&lt;/html&gt;";
    } else {
        body = body.replace("${counterValues}", table);
        body = "&lt;html&gt;\n" + body + "\n&lt;/html&gt;";
    }
    
    return body;
}


function sendCounterWarningMail(toUsers, counterValues) {
    if (toUsers == null || toUsers.length == 0) {
        toUsers = ["falcon"];
    }
    
    var fromUser = funcs.operator();
    
    var mail = new SCFile("mail");
    mail["user.to"] = "scheduler";
    mail["user.from"] = fromUser;
    mail["user.array"] = toUsers;

    mail["date.to.send"] = funcs.tod();
    mail["status"] = "sent";
    mail["mailno"] = new Datum();
    var no = new Datum();
    funcs.rtecall("getnumber", 1, no, "mail");
    mail["mailno"] = no;
    
    mail["application"] = "email"
    
    var body = "";
    var template = new SCFile("htmltemplates");
    var rc = template.doSelect("name=\"Counter Upper Limit Warning\" and language=\""+ lib.htmlemailtemplates.getLang(fromUser) +"\"");
    if (rc == RC_SUCCESS) {
        mail["subject"] = template["mail.title"];
        body = template["htmlcode"];
    } else {
        mail["subject"] = "Warning: the value of counters/number is close to the upper limit! ";
    }
    
    body = generateCounterWarningMailBody(counterValues, body);
    
    if (body == null) {
        return;
    }
    
    mail["text"].push(body);

    var rteNames = new Datum();
    rteNames.push("file");
    var rteValues = new Datum();
    rteValues.push(mail);
    funcs.rtecall("callrad", new SCDatum(), "mail.send.sched", rteNames, rteValues, false);
}

function checkCounterWarning(toUsers, value) {
    if (value != null &amp;&amp; value &gt; 0) {
        WARNING_VALUE = value;
    }
    
    var counterValues = getConsumedWarningCounters();
    var numberValues = getConsumedWarningNumbers();
    
    counterValues = lib.ArrayUtil.merge(counterValues, numberValues);
    
    sendCounterWarningMail(toUsers, counterValues);
}

</script>
    <package type="string">Monitor</package>
    <sysmodtime type="dateTime">05/21/18 18:31:35</sysmodtime>
    <sysmoduser type="string">zhouanqing</sysmoduser>
    <sysmodcount type="decimal">0</sysmodcount>
    <prgnsystem NullValue="1" type="boolean"/>
    <sysrestricted NullValue="1" type="boolean"/>
  </record>
</recordset>

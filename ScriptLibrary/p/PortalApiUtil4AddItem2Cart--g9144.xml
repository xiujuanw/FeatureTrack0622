<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<recordset table="ScriptLibrary">
  <record id="name=&quot;PortalApiUtil4AddItem2Cart&quot;" recordid="PortalApiUtil4AddItem2Cart">
    <name type="string">PortalApiUtil4AddItem2Cart</name>
    <script type="string">var log = lib.ScAPI_Logger.log("PortalApiUtil4AddItem2Cart");

var select               = lib.ScAPI_RAD._select;
var SVCCATALOG_FILE      = lib.ScAPI_Constants.JOINSVCDISPLAY_FILENAME();
var dealCartRequest      = lib.ScAPI_WSInterface_Update_Item.dealCartRequest;
var checkInteractionCart = lib.ScAPI_WSInterface_svcCart_Util.checkInteractionCart;
var getMessage           = lib.ScAPI_Util.getMessage;
var validateOrder        = lib.ScAPI_WSInterface_svcCart_Util.validateOrder;
var getCurrentOperator   = lib.ScAPI_Util.getCurrentOperator;

var oper = getCurrentOperator();
var defaultCurrency = oper.display_currency_code || vars.$G_root_currency;

function addItemToCart(pItemId, pCartId, pObjSvcCatAddItem) {
  vars.$L_file = pObjSvcCatAddItem;

  var item = _getItemDetail(pItemId);
  var cartId = vars.$L_file["cartId"] = pCartId;

  if (item == null || cartId == null) return null;

  if (item.active == false || item.infoOnly == "false") return null;
  if (item.infoOnly == true || item.infoOnly == "true") return null;

  try {
    var cart = _getCartDetail(cartId);

    if (cart == null) return null;

    var interaction = _getInteractionFromCart(cart);
    checkInteractionCart(interaction, cart);

    if (item.type == "item" || item.type == "bundle" ) { 
      vars.$L_file["cartItemId"] = _addItemToCart(item,cartId,vars.$L_file);
    } else {
      return null;
    }

    if(interaction != null) dealCartRequest(cart, interaction);
  } catch( ex ) {
    log.error(ex);
    print("error:["+system.functions.str(ex)+"]");
  }

  return vars.$L_file;
}

//return cart item ID
function _addItemToCart(item, cartId, order) {
	if (! order) return null;	
	var cartItem = null,cartItemID = null;
	var requestedFor = order["requested.for"];
	var requestedForDept = order["requested.for.dept"];
	var requestedForType = order["requested.for.type"];
    var quantity = order["quantity"];
    var delivery = order["delivery"];
    var serviceSLA = order["serviceSLA"];
    var options = order["options"];
    
	
	/*
	 *It is possible the "incidents['contact.name'] field removed from tailoring(Especially for "support catalog"). 
	 *In this case, "request.for" won't set by SRC-UI.
	 */
	if (!requestedFor) {
		requestedFor = oper["contact.name"];
	}
	
    validateOrder(item, order);

	if (log.isDebug()) {
		log.debug("cartId:"+cartId);
		log.debug("options:"+ options);
		log.debug("requestedFor:"+requestedFor);
		log.debug("quantity:"+quantity);
		log.debug("delivery:"+delivery);
		log.debug("serviceSLA:"+serviceSLA);
	}

	//convert the options to correct currency
	var old_currency=lib.svcCatalog.getCatCurrency(item.name);	
	options = lib.ScAPI_RAD.fix_bundle_opts_currency(options, old_currency, defaultCurrency, false, item["option.costs"] ).getForm();
	var cartItemHandler = lib.ScAPI_CartItem.createCartItemHandler( item.name,cartId);
	if (item.type == "item") {
		cartItem = cartItemHandler.addItemToCart(requestedFor,quantity,options,delivery,serviceSLA,requestedForType,requestedForDept,null,defaultCurrency);
	}else{
		cartItem = cartItemHandler.addItemToCart(requestedFor,quantity,options,delivery,serviceSLA,requestedForType,requestedForDept,vars.$L_file,defaultCurrency);
	}
	if (cartItem != null){
		cartItemID = cartItem.cartItemId ;
	}
	return cartItemID;
}

function _getItemDetail(pItemId)
{
  var query = "id=\""+pItemId+"\"";
  var item = select(SVCCATALOG_FILE, query);

  if (item==null || item.syslanguage==null) {
    query = query + " and syslanguage like \"*\"";
    item = select(SVCCATALOG_FILE, query);
  }

  return item;	
}

function _getCartDetail(cartId)
{
  return select("svcCart", "cartId="+cartId);
}

function _getInteractionFromCart(cart)
{
  if (cart==null || cart.sdID==null || cart.sdID=="") return null;

  return select("incidents", "incident.id=\"" + cart.sdID + "\"");
}

/*
vars.$L_file = new SCFile("svcCatAddItem");
vars.$L_file.cartId = 159;
vars.$L_file.requested_for = "Jennifer Falcon";
//add item

vars.$L_file.name = "pf test";
vars.$L_file.quantity = 1;
vars.$L_file.requested_for_type = "individual";
vars.$L_file.options = "&lt;form&gt;&lt;checkbox id=\"test\" label=\"test [+$10.00]\"&gt;true&lt;/checkbox&gt;&lt;/form&gt;";

//add bundle
vars.$L_file.name = "New Application Hosting";
vars.$L_file.quantity = 2;
vars.$L_file.options = "&lt;form&gt;&lt;label id=\"opt1\"&gt;(1) Hardware Specification and Capacity Planning&lt;/label&gt;&lt;label id=\"opt2\"&gt;(1) Hardware Installation and Configuration&lt;/label&gt;&lt;label id=\"opt3\"&gt;(1) Software Installation&lt;/label&gt;&lt;label id=\"opt4\"&gt;(1) Network Capacity and Planning&lt;/label&gt;&lt;label id=\"opt5\"&gt;(1) Network Installation and Configuration&lt;/label&gt;&lt;label id=\"opt6\"&gt;(1) New Mobile Employee Bundle&lt;/label&gt;&lt;/form&gt;";

var i = 0;
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="New Application Hosting";
vars.$L_file.option_list[i++].subOptions="&lt;form&gt;&lt;label id=\"opt1\"&gt;(1) Hardware Specification and Capacity Planning&lt;/label&gt;&lt;label id=\"opt2\"&gt;(1) Hardware Installation and Configuration&lt;/label&gt;&lt;label id=\"opt3\"&gt;(1) Software Installation&lt;/label&gt;&lt;label id=\"opt4\"&gt;(1) Network Capacity and Planning&lt;/label&gt;&lt;label id=\"opt5\"&gt;(1) Network Installation and Configuration&lt;/label&gt;&lt;label id=\"opt6\"&gt;(1) New Mobile Employee Bundle&lt;/label&gt;&lt;/form&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Hardware Specification and Capacity Planning";
vars.$L_file.option_list[i++].subOptions="&lt;form&gt;&lt;checkbox id=\"testt\" label=\"test [+$5.00]\"&gt;true&lt;/checkbox&gt;&lt;text id=\"number\" label=\"number\"&gt;40&lt;/text&gt;&lt;/form&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Hardware Installation and Configuration";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Software Installation";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Network Capacity and Planning";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Network Installation and Configuration";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="New Mobile Employee Bundle";
vars.$L_file.option_list[i++].subOptions="&lt;form&gt;&lt;label id=\"opt1\"&gt;(1) Standard Laptop Bundle&lt;/label&gt;&lt;label id=\"opt2\"&gt;(1) PC Backup&lt;/label&gt;&lt;label id=\"opt3\"&gt;(1) Employee Mailbox&lt;/label&gt;&lt;label id=\"opt4\"&gt;(1) Business Call from Home&lt;/label&gt;&lt;label id=\"opt5\"&gt;(1) Employee Remote Access&lt;/label&gt;&lt;/form&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Standard Laptop Bundle";
vars.$L_file.option_list[i++].subOptions="&lt;form&gt;&lt;label id=\"opt1\"&gt;(1) Performance Laptop&lt;/label&gt;&lt;label id=\"opt2\"&gt;(1) Docking Station&lt;/label&gt;&lt;label id=\"opt3\"&gt;(1) Flat Screen Monitor&lt;/label&gt;&lt;/form&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Performance Laptop";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Docking Station";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Flat Screen Monitor";
vars.$L_file.option_list[i++].subOptions="&lt;form&gt;&lt;select id=\"size\" label=\"Size\" style=\"radio\"&gt;twentyone&lt;option label=\"17 Inch\"&gt;seventeen&lt;/option&gt;&lt;option label=\"21 Inch [+$250.00]\"&gt;twentyone&lt;/option&gt;&lt;/select&gt;&lt;/form&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="PC Backup";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Employee Mailbox";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Business Call from Home";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Employee Remote Access";
vars.$L_file.option_list[i++].subOptions="&lt;form/&gt;";
vars.$L_file.option_list[i].subItemId=i;
vars.$L_file.option_list[i].subItemName="Hardware Specification and Capacity Planning";
vars.$L_file.option_list[i++].subOptions="&lt;form&gt;&lt;checkbox id=\"testt\" label=\"test [+$5.00]\"&gt;true&lt;/checkbox&gt;&lt;text id=\"number\" label=\"number\"&gt;40&lt;/text&gt;&lt;/form&gt;";

addItemToCart();*/



</script>
    <package type="string">Portal</package>
    <sysmodtime type="dateTime">10/24/16 20:42:54</sysmodtime>
    <sysmoduser type="string">falcon</sysmoduser>
    <sysmodcount type="decimal">1</sysmodcount>
    <prgnsystem NullValue="1" type="boolean"/>
    <sysrestricted NullValue="1" type="boolean"/>
  </record>
</recordset>

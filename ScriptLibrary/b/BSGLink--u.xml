<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<recordset table="ScriptLibrary">
  <record id="name=&quot;BSGLink&quot;" recordid="BSGLink">
    <name type="string">BSGLink</name>
    <script type="string">function getBsgLinkQuery(field) {
    var displayName=system.functions.get_display_value(vars.$File, field);
    return getBsgLinkQueryByValue(displayName);
}

function getBsgLinkQueryByValue(displayName) {
    var query = 'type~="bizservice"';
    
    if (vars.$L_file.affected_item != null)
    {    
        query='select d.logical.name, d.sm.device.display.name, d.type, d.subtype, d.current.phase, d.istatus'
        +' from device d inner join cirelationbsg r on (d.logical.name=r.child) where d.type~=\"bizservice\" and r.parent="'+vars.$L_file.affected_item+'" and r.level&lt;='+vars.$G_cilevel;
        
        if (vars['$G.multi'] &amp;&amp; vars.$File.company!=null){
            query = query+' and (d.company="'+lib.StringUtil.escapeAllStr(vars.$File.company) +'" or d.company="DEFAULT")'
        }
        
        if (displayName!=null) {
            query = query+' and d.display.name#"'+lib.StringUtil.escapeAllStr(displayName)+'"'    
        }    
    }
    else if (displayName != null)
    {
        query = "display.name#\"" + lib.StringUtil.escapeAllStr(displayName) + "\" and type~=\"bizservice\"";
        if (vars['$G.multi'] &amp;&amp; vars.$File.company!=null){
            query = query+' and (d.company="'+lib.StringUtil.escapeAllStr(vars.$File.company) +'" or d.company="DEFAULT")'
        }
    }
    
    return query;
}

function getBsgLinkQueryForArray(field) {
	var logicalNameDis = null;
	var idx = system.functions.cursor_line(1);
	if (idx &gt; 0 &amp;&amp; vars.$File[field][idx-1] != null) {	
		var logicalNameDis=vars.$File[field][idx-1];
	}
	
	return getBsgLinkQueryByValue(logicalNameDis);
}


function isValidServiceToCi(service, ci) {
	var device = new SCFile("device", SCFILE_READONLY);
	device.setFields(["logical.name"]);
		
	var result = device.doSelect("logical.name = \"" + ci + "\" and type~=\"bizservice\"");
	var valid = (RC_SUCCESS == result);
	if (valid) {
		var sql = 'parent="'+lib.StringUtil.escapeAllStr(service)+'" and child="'+lib.StringUtil.escapeAllStr(ci)+'" and level&lt;=$G.cilevel';
		valid = lib.c.$('cirelationbsg').count(sql) &gt; 0;
	}
	
	if (!valid) {
		return false;
	}
	
	return true;
}
</script>
    <package type="string">Configuration Management</package>
    <sysmodtime type="dateTime">12/13/18 17:48:13</sysmodtime>
    <sysmoduser type="string">qiqingsong</sysmoduser>
    <sysmodcount type="decimal">8</sysmodcount>
    <prgnsystem NullValue="1" type="boolean"/>
    <sysrestricted NullValue="1" type="boolean"/>
  </record>
</recordset>
